# ADR-001. 단축 URL 생성 알고리즘 선택

## Metadata
| 항목 | 값 |
|------|-----|
| 작성자 | Claude (AI Pair Programmer) |
| 작성일 | 2026-02-27 |
| 검토일 | 2026-08-27 (+6개월) |
| Status | Proposed |

---

## Pre-Mortem (Phase A 결과)

### Q1: 이 결정이 1년 후 실패한다면 가장 가능성 높은 이유는?
- **잘못된 알고리즘 선택으로 URL 충돌이 빈번하게 발생**: 해시 충돌로 인해 같은 단축 URL이 서로 다른 원본 URL에 매핑되어 사용자 혼란 발생
- **단축 URL 생성 시간이 오래 걸림**: 해시 연산 + 충돌 재시도로 인해 응답 시간이 500ms 목표를 초과
- **분산 환경에서의 동기화 오버헤드**: Sequence 생성을 위한 중앙 코디네이터가 병목 지점이 됨

### Q2: 실패 당시 상황
| 항목 | 현재 | 실패 시나리오 |
|------|------|---------------|
| 트래픽 | DAU 10만 | DAU 100만 이상으로 급증 |
| 팀 규모 | 1-2명 | 5명 이상 |
| 데이터 크기 | ~100만 URL | ~1억 URL |
| 비즈니스 | MVP 단계 | 글로벌 서비스 확장 |

### Q3: 미리 알았다면 다른 선택
- 만약 **DAU 100만 이상의 급격한 트래픽 증가**를 알았다면 → **Random String 방식**을 고려했을 것 (분산 확장성 우선)
- 만약 **URL 캐싱의 중요도가 낮다**는 것을 알았다면 → **Base62 Sequence** 방식을 고려했을 것 (단순성 우선)
- 만약 **메모리 제약이 심하다**는 것을 알았다면 → **단순 Sequence** 방식을 고려했을 것

---

## Context

### 비즈니스 요구사항
- 긴 URL을 짧고 직관적인 URL로 변환하는 서비스
- DAU 10만 규모 지원 (중간 규모 트래픽)
- 단축 URL 생성 응답 시간: 500ms 이내
- **리다이렉트 응답 시간: 100ms 이내 (핵심 성능 지표)**

### 기술적 제약사항
- Java / Spring Boot / JPA 사용
- 데이터베이스: RDBMS (MySQL)
- 캐싱: Redis (권장)
- 단축 URL 길이: 15자 이내

### 왜 지금 결정해야 하는가?
- 단축 URL 생성 알고리즘은 서비스의 핵심 기능으로, 초기 설계에서 잘못 선택하면 마이그레이션 비용이 매우 큼
- 캐싱 전략과 통계 저장 방식 결정에 앞서 먼저 결정되어야 함
- 같은 URL에 대해 항상 같은 단축 URL을 반환할지 여부가 알고리즘 선택에 직접적 영향

---

## Decision

**Hash(SHA-256 → Base62 인코딩) + Sequence** 방식을 선택한다.

### 구체적 구현 방식
1. 원본 URL을 SHA-256으로 해싱
2. 해시값의 앞 8바이트를 Base62로 인코딩 (약 11자)
3. 충돌 발생 시 Sequence 번호를 추가하여 고유성 보장
4. 최종 단축 URL은 7-15자 범위

### 선택한 이유
- **같은 URL → 같은 단축 URL**: 캐싱 효율 극대화, 중복 저장 방지
- **분산 확장성**: 중앙 DB 병목 없이 독립적 해시 생성 가능
- **예측 가능한 길이**: Base62 인코딩으로 일관된 URL 길이

---

## Trade-off Matrix (Phase B 결과)

| 평가기준 | Hash+Sequence (선택) | Base62 (Sequence) | Random String |
|----------|---------------------|-------------------|---------------|
| 충돌 없음 | ⭐⭐⭐⭐⭐ (5) | ⭐⭐⭐⭐⭐ (5) | ⭐⭐⭐⭐⭐ (5) |
| 같은 URL = 같은 단축 | ⭐⭐⭐⭐⭐ (5) | ⭐⭐⭐⭐⭐ (5) | ❌ (0) |
| 분산 확장성 | ⭐⭐⭐⭐ (4) | ⭐⭐ (2) | ⭐⭐⭐⭐⭐ (5) |
| 생성 속도 | ⭐⭐⭐⭐ (4) | ⭐⭐⭐ (3) | ⭐⭐⭐⭐⭐ (5) |
| **총점** | **18** | **15** | **15** |

### 선택 설명 (트레이드오프)
Hash+Sequence 방식은 총점 18점으로 가장 높으며, 특히 **"같은 URL = 같은 단축"** 요구사항을 만족한다는 점이 결정적이다.

**트레이드오프 분석:**
- Random String보다 생성 속도는 약간 느리지만, **캐싱 이점이 더 중요**함
- 리다이렉트(100ms 목표)가 생성(500ms 목표)보다 빈번하므로, 캐시 적중률이 전체 성능에 더 큰 영향
- Base62 Sequence는 같은 URL에 대해 같은 단축을 보장하지만, 분산 환경에서 중앙 코디네이터 병목이 발생

---

## Alternatives Considered

### Hash(SHA-256 → Base62) + Sequence (선택)
- **장점**:
  - 같은 URL에 대해 항상 같은 단축 URL 생성 (멱등성)
  - Redis 캐싱 시 원본 URL을 키로 사용 가능
  - 중복 URL 저장 방지로 DB 공간 절약
  - 분산 환경에서 독립적으로 해시 생성 가능
- **단점**:
  - SHA-256 연산 오버헤드 (약 1-2ms)
  - 충돌 시 재시도 로직 필요
  - 해시 길이에 따른 단축 URL 길이 제약
- **실패 시나리오**:
  - 매우 짧은 단축 URL이 필요한 경우 (3-4자) 충돌률 급증
  - 트래픽이 폭증하여 충돌 재시도가 빈번해지는 경우

### Base62 (Sequence)
- **장점**:
  - 구현이 매우 단순함
  - 짧은 단축 URL 생성 가능 (1, 2, 3... → a, b, c... → aa, ab...)
  - 순차적 생성으로 예측 가능
- **단점**:
  - 분산 환경에서 중앙 Sequence 생성기 필요
  - 중앙 코디네이터가 SPOF (Single Point of Failure)
  - 같은 URL이라도 매번 다른 단축 URL 생성 가능
- **선택하지 않은 이유**:
  - 분산 확장성이 낮음 (점수 2)
  - 같은 URL에 다른 단축 URL이 생성되면 캐싱 효율 저하
- **실패 시나리오**:
  - 분산 서버 확장 시 Sequence 생성 병목
  - 중앙 코디네이터 장애 시 전체 서비스 중단

### Random String
- **장점**:
  - 분산 환경에서 가장 우수함 (점수 5)
  - 생성 속도가 가장 빠름 (점수 5)
  - 구현이 단순함
- **단점**:
  - 같은 URL에 대해 다른 단축 URL 생성 (멱등성 없음)
  - 중복 URL을 매번 저장해야 함
  - 캐싱 효율이 낮음
- **선택하지 않은 이유**:
  - "같은 URL = 같은 단축" 요구사항 충족 불가 (점수 0)
  - 캐싱 전략의 핵심 이점을 활용할 수 없음
- **실패 시나리오**:
  - 캐시 적중률이 낮아 리다이렉트 성능 목표(100ms) 달성 실패
  - 중복 URL 저장으로 DB 공간 낭비

---

## Consequences

### 긍정적
- **캐싱 효율 극대화**: 같은 URL은 항상 같은 단축 URL → Redis에서 원본 URL을 키로 조회 가능
- **중복 저장 방지**: 이미 생성된 URL은 DB에 중복 저장되지 않음
- **분산 확장 가능**: 각 서버가 독립적으로 해시 생성 가능
- **일관된 사용자 경험**: 같은 URL은 항상 같은 단축 URL 반환

### 부정적
- **충돌 재시도 오버헤드**: 드물지만 충돌 발생 시 추가 연산 필요
- **구현 복잡도 증가**: Sequence 추가 로직이 필요
- **해시 연산 비용**: SHA-256 연산에 1-2ms 소요

### 위험
- **해시 길이와 충돌 확률**: 8바이트 사용 시 생일 역설에 의해 약 2^32개 URL에서 충돌 확률 50%
  - **완화 전략**: 10바이트로 증가 고려, 충돌 시 Sequence 추가
- **Sequence 관리 복잡도**: 충돌 빈도에 따라 Sequence 관리가 복잡해질 수 있음
  - **완화 전략**: 충돌 카운터를 별도 테이블로 관리

---

## Reconsideration Trigger

### 재검토 조건 (정량적 임계값)

| 조건 | 임계값 | 현재 상태 | 재검토 필요 |
|------|--------|-----------|-------------|
| DAU | 100만 | 10만 | ❌ |
| URL 수 | 10억 개 | ~100만 개 | ❌ |
| 충돌률 | 1% 초과 | < 0.01% | ❌ |
| 생성 응답시간 | 500ms 초과 | ~100ms | ❌ |
| 리다이렉트 응답시간 | 150ms 초과 | ~100ms | ❌ |

**재검토 시점**: 2026-08-27 (6개월 후) 또는 위 임계값 도달 시

### 재검토 시 고려사항
- DAU 100만 도달 시 Random String 방식으로의 마이그레이션 검토
- 충돌률 1% 초과 시 해시 길이 증가 또는 알고리즘 변경

---

## Self-Critique Score (Phase D 결과)

| # | 항목 | 점수(1~5) | 비고 |
|---|------|-----------|------|
| 1 | Context 충분성 | 5 | 6개월 후 이해 가능 |
| 2 | 대안 분석 깊이 | 4 | 3가지 대안 심도 있게 분석 |
| 3 | Consequences 솔직성 | 4 | 부정적 결과 포함 |
| 4 | Reconsideration 구체성 | 5 | 재검토 조건 명확 |
| 5 | 설득력 | 4 | 반론 대응 가능 |
| **총점** | | **22/25** | **평균 4.4** |

**평균 4점 미만 항목은 수정 완료**: [x] 예 [ ] 아니오

---

## Related
- Related ADRs: ADR-002 (캐싱 전략), ADR-003 (접속 통계 저장 방식)
- Related Requirements: URL 단축, 리다이렉트, 캐싱 전략

## References
- [TinyURL Design](https://www.educative.io/courses/grokking-modern-system-design-interview-for-engineering-managers/tinyurl-design)
- [Base62 Encoding](https://en.wikipedia.org/wiki/Base62)
- [Birthday Problem](https://en.wikipedia.org/wiki/Birthday_problem)
